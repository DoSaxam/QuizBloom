<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuizBee</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- GSAP for animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" integrity="sha512-1XPTGuiFBuSZqXhTJ6iS0Mltj0XF0k1vRxyhuS+01g353kPiCKwM7mkpMiJh4zxDgzERXpdN0vMgybCptpRzeg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    /* Custom styles & overrides */
    @layer base {
      html {
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
          Helvetica, Arial, "Noto Sans", sans-serif;
      }
    }

    /* Gradient background & grain overlay */
    body {
      @apply h-full bg-gradient-to-br from-slate-800 to-slate-900 text-slate-100 relative overflow-hidden;
    }
    .grain {
      pointer-events: none;
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMCcgaGVpZ2h0PScwJy8+");
      mix-blend-mode: soft-light;
      opacity: 0.05;
      animation: grain 8s steps(10) infinite;
    }
    @keyframes grain {
      0%, 100% { transform: translate(0,0); }
      20% { transform: translate(-5%, 5%); }
      40% { transform: translate(-10%, -5%); }
      60% { transform: translate(5%, 10%); }
      80% { transform: translate(10%, -10%); }
    }

    /* Card glassmorphism */
    .card {
      @apply backdrop-blur-md bg-white/5 rounded-2xl shadow-lg shadow-black/30;
    }

    /* Ripple effect */
    .ripple {
      position: absolute;
      border-radius: 9999px;
      transform: translate(-50%, -50%);
      background: currentColor;
      opacity: 0.15;
      animation: ripple 600ms linear;
      pointer-events:none;
    }
    @keyframes ripple {
      from { width: 0; height: 0; opacity: 0.4; }
      to   { width: 200px; height: 200px; opacity: 0; }
    }

    /* Bee z-index help */
    .bee {
      pointer-events: none;
      z-index: 0;
    }
    main, nav { position: relative; z-index: 1; }
  </style>
</head>
<body class="h-full flex flex-col">
  <!-- Decorative grain overlay -->
  <div class="grain"></div>

  <!-- SVG Icon sprite (minimal) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9.5L12 4l9 5.5V20a2 2 0 0 1-2 2h-3a2 2 0 0 1-2-2v-4H8v4a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9.5z"></path>
    </symbol>
    <symbol id="icon-play" viewBox="0 0 24 24" fill="currentColor">
      <path d="M5 3l14 9-14 9V3z"></path>
    </symbol>
    <symbol id="icon-trophy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 21h8M12 17v4M17 4h2a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V6a2 2 0 0 1 2-2h2"></path>
    </symbol>
    <symbol id="icon-store" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9l1-5h16l1 5M5 22h14a2 2 0 0 0 2-2V9H3v11a2 2 0 0 0 2 2z"></path>
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </symbol>
  </svg>

  <!-- Bee background wrapper -->
  <div id="bee-bg" class="absolute inset-0 overflow-hidden pointer-events-none"></div>

  <!-- Main content router outlet -->
  <main id="app" class="flex-1 overflow-y-auto pb-20"></main>

  <!-- Bottom navigation -->
  <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[95%] max-w-md bg-white/5 backdrop-blur-md rounded-3xl py-2 flex justify-around shadow-lg shadow-black/40" aria-label="Bottom navigation">
    <button class="tab-btn flex flex-col items-center gap-1 px-2" data-route="/home" aria-label="Home">
      <svg class="w-6 h-6"><use href="#icon-home" /></svg>
      <span class="text-xs">Home</span>
    </button>
    <button class="tab-btn flex flex-col items-center gap-1 px-2" data-route="/play" aria-label="Play">
      <svg class="w-6 h-6"><use href="#icon-play" /></svg>
      <span class="text-xs">Play</span>
    </button>
    <button class="tab-btn flex flex-col items-center gap-1 px-2" data-route="/achievements" aria-label="Achievements">
      <svg class="w-6 h-6"><use href="#icon-trophy" /></svg>
      <span class="text-xs">Badges</span>
    </button>
    <button class="tab-btn flex flex-col items-center gap-1 px-2" data-route="/store" aria-label="Store">
      <svg class="w-6 h-6"><use href="#icon-store" /></svg>
      <span class="text-xs">Store</span>
    </button>
    <button class="tab-btn flex flex-col items-center gap-1 px-2" data-route="/settings" aria-label="Settings">
      <svg class="w-6 h-6"><use href="#icon-settings" /></svg>
      <span class="text-xs">Settings</span>
    </button>
  </nav>

  <script>
  ;(() => {
    /* ========================================================
       Utility helpers
    ======================================================= */
    const htmlDecode = (input) => {
      const e = document.createElement('textarea');
      e.innerHTML = input;
      return e.value;
    };
    const randChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const throttle = (fn, wait) => {
      let last = 0;
      return (...args) => {
        const now = Date.now();
        if (now - last >= wait) {
          last = now;
          fn(...args);
        }
      };
    };

    /* ========================================================
       Simple KV Store with localStorage persistence
    ======================================================= */
    const Store = (() => {
      const defaultState = {
        xp: 0,
        coins: 0,
        streak: { current: 0, best: 0, last: 0 },
        settings: { sound: true, haptics: true, motion: 'high' },
        achievements: {},
      };
      let state = { ...defaultState, ...(JSON.parse(localStorage.getItem('quizbee') || '{}')) };
      const save = () => localStorage.setItem('quizbee', JSON.stringify(state));
      const get = () => state;
      const set = (partial) => { state = { ...state, ...partial }; save(); };
      return { get, set };
    })();

    /* ========================================================
       Audio module (Web Audio API)
    ======================================================= */
    const AudioFX = (() => {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const clips = {
        tap: 'UklGRmwAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=', // silence placeholder
        correct: 'UklGRmwAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=',
        wrong: 'UklGRmwAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=',
      };
      const buffers = {};
      const load = (name) => {
        if (buffers[name]) return Promise.resolve(buffers[name]);
        const data = atob(clips[name]);
        const arr = new Uint8Array(data.length);
        for (let i = 0; i < data.length; ++i) arr[i] = data.charCodeAt(i);
        return ctx.decodeAudioData(arr.buffer).then((buf) => (buffers[name] = buf));
      };
      const play = (name) => {
        if (!Store.get().settings.sound) return;
        load(name).then((buf) => {
          const src = ctx.createBufferSource();
          src.buffer = buf;
          src.connect(ctx.destination);
          src.start();
        });
      };
      return { play };
    })();

    /* ========================================================
       Haptics module
    ======================================================= */
    const Haptics = (() => {
      const light = () => {
        if (window.Capacitor?.Haptics) {
          window.Capacitor.Haptics.impact({ style: 'light' });
        } else if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      };
      const success = () => {
        if (window.Capacitor?.Haptics) {
          window.Capacitor.Haptics.impact({ style: 'heavy' });
        } else if (navigator.vibrate) {
          navigator.vibrate([20, 30, 20]);
        }
      };
      return { light, success };
    })();

    /* ========================================================
       Toast System
    ======================================================= */
    const Toast = (() => {
      const container = document.createElement('div');
      container.className = 'fixed top-4 inset-x-0 flex flex-col items-center gap-2 z-[200]';
      document.body.appendChild(container);
      const show = (msg, variant = 'info', timeout = 3000) => {
        const el = document.createElement('div');
        el.className = `card px-4 py-2 text-sm animate-pop`;
        el.textContent = msg;
        container.appendChild(el);
        setTimeout(() => el.remove(), timeout);
      };
      return { show };
    })();

    /* ========================================================
       Trivia API client
    ======================================================= */
    const TriviaAPI = (() => {
      const fetchQuestions = async ({ amount = 10, category, difficulty }) => {
        const url = new URL('https://opentdb.com/api.php');
        url.searchParams.set('amount', amount);
        if (category) url.searchParams.set('category', category);
        if (difficulty) url.searchParams.set('difficulty', difficulty);
        url.searchParams.set('type', 'multiple');
        for (let i = 0, delay = 500; i < 3; i++, delay *= 2) {
          try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.response_code === 0) {
              return data.results.map((q) => ({
                ...q,
                question: htmlDecode(q.question),
                correct_answer: htmlDecode(q.correct_answer),
                incorrect_answers: q.incorrect_answers.map(htmlDecode),
              }));
            } else {
              throw new Error('No results');
            }
          } catch (err) {
            if (i === 2) throw err;
            await new Promise((r) => setTimeout(r, delay));
          }
        }
      };
      return { fetchQuestions };
    })();

    /* ========================================================
       Bee background animation
    ======================================================= */
    const BeeBG = (() => {
      const container = document.getElementById('bee-bg');
      const beeSVG = `<svg class="bee absolute w-5 h-5 text-yellow-300 drop-shadow-[0_0_4px_rgba(255,255,255,0.4)]" viewBox="0 0 24 24" fill="currentColor" opacity="0.8"><path d="M12 3c-2.5 0-4.5 2-4.5 4.5S9.5 12 12 12s4.5-2 4.5-4.5S14.5 3 12 3zm0 1.5a3 3 0 110 6 3 3 0 010-6z"/><circle cx="9" cy="16" r="3"/><circle cx="15" cy="16" r="3"/></svg>`;
      const bees = [];
      const init = () => {
        const num = Math.floor(randChoice([5,6,7,8,9,10,11,12]));
        for (let i = 0; i < num; i++) {
          const temp = document.createElement('div');
          temp.innerHTML = beeSVG;
          const bee = temp.firstChild;
          container.appendChild(bee);
          bees.push(bee);
          animateBee(bee);
        }
      };
      const animateBee = (bee) => {
        const path = [
          { x: rand(-40, 40), y: rand(-40, 40) },
          { x: rand(-60, 60), y: rand(-60, 60) },
          { x: rand(-40, 40), y: rand(-40, 40) },
        ];
        const dur = rand(12, 20);
        gsap.fromTo(bee, { x: 0, y: 0 }, {
          motionPath: { path },
          repeat: -1,
          duration: dur,
          ease: 'none',
          yoyo: true,
          modifiers: {
            x: (x) => `${parseFloat(x).toFixed(2)}vw`,
            y: (y) => `${parseFloat(y).toFixed(2)}vh`,
          }
        });
      };
      const rand = (min, max) => Math.random() * (max - min) + min;
      init();
    })();

    /* ========================================================
       Router & Views
    ======================================================= */
    const Router = (() => {
      const routes = {
        '/home': renderHome,
        '/play': renderPlay,
        '/achievements': renderStub('Achievements coming soon!'),
        '/store': renderStub('Store coming soon!'),
        '/settings': renderSettings,
      };
      const app = document.getElementById('app');
      function renderHome() {
        app.innerHTML = `
          <section class="p-6 flex flex-col gap-6">
            <h1 class="text-4xl font-bold tracking-tight">QuizBee</h1>
            <button id="quick-start" class="card py-3 px-6 text-lg font-semibold hover:scale-105 active:scale-95 transition-transform">Quick Start</button>
          </section>
        `;
        document.getElementById('quick-start').addEventListener('click', () => {
          navigate('/play');
        });
      }
      async function renderPlay() {
        app.innerHTML = `<section class="p-4 h-full flex flex-col gap-4 items-center justify-center text-center">Loading...</section>`;
        try {
          const qs = await TriviaAPI.fetchQuestions({ amount: 10 });
          renderQuestionRound(qs);
        } catch (err) {
          Toast.show('Failed to load questions.');
          app.innerHTML = '';
        }
      }
      function renderQuestionRound(qs) {
        let idx = 0;
        const render = () => {
          const q = qs[idx];
          const answers = [...q.incorrect_answers, q.correct_answer].sort(() => Math.random() - 0.5);
          app.innerHTML = `
            <section class="p-6 flex flex-col gap-6">
              <div class="card p-4 text-sm flex items-center justify-between">Q ${idx + 1}/${qs.length}</div>
              <h2 class="text-lg font-medium">${q.question}</h2>
              <div class="flex flex-col gap-3">
                ${answers.map((a) => `<button class="answer card py-3 px-4">${a}</button>`).join('')}
              </div>
            </section>
          `;
          Array.from(document.querySelectorAll('.answer')).forEach((btn) => {
            btn.addEventListener('click', (e) => {
              handleAnswer(btn.textContent === q.correct_answer, btn);
            });
          });
        };
        const handleAnswer = (correct, btn) => {
          Array.from(document.querySelectorAll('.answer')).forEach((b) => b.disabled = true);
          btn.classList.add(correct ? 'ring-2', correct ? 'ring-green-400' : 'ring-red-400');
          AudioFX.play(correct ? 'correct' : 'wrong');
          (correct ? Haptics.success : Haptics.light)();
          setTimeout(() => {
            if (++idx < qs.length) render();
            else endRound();
          }, 800);
        };
        const endRound = () => {
          Toast.show('Round complete!', 'success');
          navigate('/home');
        };
        render();
      }
      function renderSettings() {
        const { settings } = Store.get();
        app.innerHTML = `
          <section class="p-6 flex flex-col gap-4">
            <h2 class="text-xl font-semibold">Settings</h2>
            <label class="flex items-center gap-3">Sound <input id="toggle-sound" type="checkbox" ${settings.sound ? 'checked' : ''}></label>
            <label class="flex items-center gap-3">Haptics <input id="toggle-haptics" type="checkbox" ${settings.haptics ? 'checked' : ''}></label>
          </section>
        `;
        document.getElementById('toggle-sound').addEventListener('change', (e) => {
          Store.set({ settings: { ...Store.get().settings, sound: e.target.checked } });
        });
        document.getElementById('toggle-haptics').addEventListener('change', (e) => {
          Store.set({ settings: { ...Store.get().settings, haptics: e.target.checked } });
        });
      }
      function renderStub(msg) {
        return () => {
          app.innerHTML = `<section class="p-6 text-center">${msg}</section>`;
        };
      }
      function navigate(path) {
        location.hash = path;
      }
      const onHashChange = () => {
        const path = location.hash.replace('#', '') || '/home';
        routes[path]?.();
        document.querySelectorAll('.tab-btn').forEach((btn) => {
          btn.classList.toggle('text-yellow-300', btn.dataset.route === path);
        });
      };
      window.addEventListener('hashchange', onHashChange);
      document.querySelectorAll('.tab-btn').forEach((btn) => btn.addEventListener('click', () => navigate(btn.dataset.route)));
      onHashChange();
    })();

  })();
  </script>
</body>
</html>